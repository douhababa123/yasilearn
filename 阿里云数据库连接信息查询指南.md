# 阿里云数据库连接信息查询指南

本文档指导如何在阿里云服务器上查询 PostgreSQL 数据库的连接信息。

## 1. 检查 PostgreSQL 服务状态

```bash
# 查看 PostgreSQL 是否正在运行
sudo systemctl status postgresql

# 或
pg_isready
```

## 2. 连接到 PostgreSQL 并查询信息

```bash
# 切换到 postgres 用户
sudo -i -u postgres

# 进入 psql 命令行
psql
```

或在命令行直接执行：

```bash
sudo -u postgres psql -c "SELECT version();"
```

## 3. 查询数据库连接信息

在 psql 命令行中执行以下命令：

```sql
-- 查看所有数据库
\l

-- 查看当前数据库名称
SELECT current_database();

-- 查看当前用户
SELECT current_user;

-- 查看所有角色/用户
\du

-- 查看数据库的所有连接地址
SELECT * FROM pg_hba_file_rules;
```

## 4. 获取数据库连接字符串

执行以下命令获取连接信息：

```bash
# 查看 PostgreSQL 监听地址和端口
sudo -u postgres psql -c "SHOW port;"
sudo -u postgres psql -c "SHOW listen_addresses;"
```

默认情况下：
- **端口**: `5432`
- **监听地址**: `localhost` 或 `0.0.0.0`
- **数据库名**: `postgres`（默认），或你自己创建的数据库
- **用户名**: `postgres`
- **密码**: 你安装时设置的密码

## 5. 快速获取完整连接命令

```bash
# 查看 PostgreSQL 配置
sudo -u postgres psql -c "SHOW config_file;"
```

查看 `postgresql.conf` 文件中的：
- `listen_addresses`
- `port`

查看 `pg_hba.conf` 文件确认是否允许远程连接。

## 6. 检查你项目的 .env.local 文件

在阿里云服务器的项目目录中查找：

```bash
# 查看项目目录
cd /你的项目目录

# 查看环境变量文件
cat .env.local

# 或查找所有可能的环境变量文件
ls -la | grep -E "\.env|config"
```

## 7. 测试本地连接

```bash
# 使用 psql 连接测试
sudo -u postgres psql -d ielts_db

# 或从外部测试连接（需确保防火墙和安全组已开放）
psql -h localhost -p 5432 -U postgres -d ielts_db
```

## 8. 常见问题排查

### PostgreSQL 没有监听外网 IP

编辑配置文件：
```bash
sudo nano /etc/postgresql/版本号/main/postgresql.conf
```

确保：
```
listen_addresses = '*'
port = 5432
```

然后重启：
```bash
sudo systemctl restart postgresql
```

### 防火墙未开放端口

```bash
# 查看防火墙状态
sudo ufw status

# 开放 5432 端口
sudo ufw allow 5432

# 或使用阿里云安全组（在控制台操作）
```

### pg_hba.conf 配置

确保允许你的 IP 连接：
```
# TYPE  DATABASE        USER            ADDRESS                 METHOD
host    all             all             0.0.0.0/0               md5
```

## 9. 获取 DATABASE_URL 格式

根据查询结果，你的连接字符串格式为：

```
postgres://用户名:密码@服务器IP:端口/数据库名
```

例如：
```
postgres://postgres:mypassword@123.45.67.89:5432/ielts_db
```

## 10. 在本地的 .env.local 中配置

获取到连接信息后，在本地项目的 `.env.local` 文件中添加：

```
DASHSCOPE_API_KEY=sk-xxx
DASHSCOPE_MODEL=qwen3-max
DATABASE_URL=postgres://用户名:密码@服务器IP:端口/数据库名
```

**注意**: 如果阿里云数据库只允许内网访问，你需要使用**公网 IP** 或配置 **VPN/跳板机**。
